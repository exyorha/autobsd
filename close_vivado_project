#!/usr/bin/env ruby

if ARGV.empty?
  warn "Usage: open_vivado_project <PROJECT NAME>"
  exit 1
end

project, = ARGV

File.write "projects/#{project}/export.tcl", <<EOF
write_project_tcl -force #{project}.tcl
EOF

system "C:/Xilinx/Vivado/2018.2/bin/vivado",
	"-mode", "batch",
	"../../VivadoWorkspace/#{project}/#{project}.xpr",
	"-source", "export.tcl",
	"-nolog", "-nojournal",
	chdir: "projects/#{project}"

File.delete "projects/#{project}/export.tcl"

File.open("projects/#{project}/#{project}.tcl", "r+") do |iof|
  export = iof.read
  iof.rewind

  export = export.split("\n").map! do |line|
    line.gsub!(/^.*_wrapper[^\\]*(\\?)$/) { $1 }
    line
  end.join("\n")

  export.gsub! /^# Generated by Vivado on(.*)$/, ""

  export.gsub!("set files [list \\\n\\\n]\nset imported_files [import_files -fileset sources_1 $files]\n", "")

  iof.write export
  iof.truncate iof.pos
end
